function e(e,t){if(w.apps.length>0)return void e();var n=!1,a=w.initializeApp(b.firebase);a.database().ref(".info/connected").on("value",function(t){if(t.val()===!0)return n=!0,void e()}),setTimeout(function(){if(!n)return console.error("Timeout during Firebase initialization"),void t()},3e3)}function t(e,t){var n=new w.auth.GoogleAuthProvider;n.addScope("https://www.googleapis.com/auth/calendar.readonly"),w.auth().signInWithPopup(n).then(function(t){e()}).catch(function(e){console.error("Error on Google login",e),t(e.code)})}function n(e,t,n){var a=b.googleClientID,i="https://www.googleapis.com/auth/calendar.readonly";w.auth().currentUser.getToken().then(function(s){v.load("client:auth",function(){v.auth.authorize({client_id:a,scope:i,immediate:!0},function(){v.client.load("calendar","v3",function(){var a=v.client.calendar.calendarList.list();a.execute(function(a){if(a.items){var i=null;for(var s in a.items)a.items[s].summary===e&&(i=a.items[s].id);i?v.client.request({path:"calendar/v3/calendars/"+i+"/events",params:{maxResults:2500,singleEvents:!0,timeMax:new Date((new Date).getFullYear(),(new Date).getMonth(),(new Date).getDate()+1).toISOString(),timeZone:"Europe/Berlin",orderBy:"startTime"}}).then(function(a){if(200===a.status){if(a.result.items){var i,s,r=[];for(var l in a.result.items)i=a.result.items[l],s={summary:i.summary&&""!==i.summary.trim()?i.summary:null,start:i.start.dateTime?i.start.dateTime:i.start.date,end:i.end.dateTime?i.end.dateTime:i.end.date,description:i.description&&""!==i.description.trim()?i.description:null},r.push(s);p["Dienstplan"===e?"plan":"real"]=JSON.stringify(r),t()}}else n(e+"-Einträge konnten nicht geladen werden")}):n('Erstelle einen Kalender "'+e+'" in <a href="https://calendar.google.com/" target="_blank">Google Kalender</a>')}else n('Kalender "'+e+'" konnte nicht geladen werden')})})})})})}function a(e,t){n("Dienstplan",e,t)}function i(e,t){n("Arbeitszeiten",e,t)}function s(){var e=new Date;h("#init-google").addClass("alert-info"),h("#init-google").removeClass("alert-danger"),h("#init-google").removeClass("alert-success"),h("#init-google").html('<i class="fa fa-fw fa-spinner fa-spin"></i>&nbsp;&nbsp;Google-Anmeldung läuft ...'),h("#init-google").fadeIn(),t(function(){h("#init-google").removeClass("alert-info"),h("#init-google").removeClass("alert-danger"),h("#init-google").addClass("alert-success"),h("#init-google").html('<i class="fa fa-fw fa-check"></i>&nbsp;&nbsp;Google-Anmeldung erfolgreich'),setTimeout(r,Math.max(0,e-new Date+400))},function(t){h("#init-google").removeClass("alert-info"),h("#init-google").removeClass("alert-success"),h("#init-google").addClass("alert-danger"),h("#init-google").html('<i class="fa fa-fw fa-warning"></i>&nbsp;&nbsp;'+("auth/popup-blocked"===t?"Bitte Popupblocker deaktivieren":"Google-Anmeldung fehlgeschlagen")),setTimeout(o,Math.max(0,e-new Date+400))})}function r(){var e=new Date;h("#init-plan").removeClass("alert-success"),h("#init-plan").removeClass("alert-danger"),h("#init-plan").addClass("alert-info"),h("#init-plan").html('<i class="fa fa-fw fa-spinner fa-spin"></i>&nbsp;&nbsp;Dienstplan wird geladen ...'),h("#init-plan").fadeIn(),a(function(){h("#init-plan").removeClass("alert-info"),h("#init-plan").removeClass("alert-danger"),h("#init-plan").addClass("alert-success"),h("#init-plan").html('<i class="fa fa-fw fa-check"></i>&nbsp;&nbsp;Dienstplan wurde erfolgreich geladen'),p.real?setTimeout(u,Math.max(0,e-new Date+400)):setTimeout(l,Math.max(0,e-new Date+400))},function(t){h("#init-plan").removeClass("alert-info"),h("#init-plan").removeClass("alert-success"),h("#init-plan").addClass("alert-danger"),h("#init-plan").html('<i class="fa fa-fw fa-warning"></i>&nbsp;&nbsp;'+t),setTimeout(o,Math.max(0,e-new Date+400))})}function l(){var e=new Date;h("#init-real").addClass("alert-info"),h("#init-real").removeClass("alert-danger"),h("#init-real").removeClass("alert-success"),h("#init-real").html('<i class="fa fa-fw fa-spinner fa-spin"></i>&nbsp;&nbsp;Arbeitszeiten werden geladen ...'),h("#init-real").fadeIn(),i(function(){h("#init-real").removeClass("alert-info"),h("#init-real").removeClass("alert-danger"),h("#init-real").addClass("alert-success"),h("#init-real").html('<i class="fa fa-fw fa-check"></i>&nbsp;&nbsp;Arbeitszeiten wurden erfolgreich geladen'),setTimeout(u,Math.max(0,e-new Date+400))},function(t){h("#init-real").removeClass("alert-info"),h("#init-real").removeClass("alert-success"),h("#init-real").addClass("alert-danger"),h("#init-real").html('<i class="fa fa-fw fa-warning"></i>&nbsp;&nbsp;'+t),setTimeout(o,Math.max(0,e-new Date+400))})}function o(){h("#init-button").html('<i class="fa fa-fw fa-refresh"></i>&nbsp;&nbsp;Anmeldung erneut versuchen'),h("#init-button").fadeIn(),null!==w.auth().currentUser&&h("#init-cancel-button").fadeIn()}function u(){h("#init").fadeOut(),d(),m(!0),setTimeout(function(){h("#view").fadeIn(),h("#init-button").show(),h("#init-google").hide(),h("#init-plan").hide(),h("#init-real").hide()},400)}function d(){w.database().ref("users/"+w.auth().currentUser.uid+"/address").on("value",function(e){var t=e.val();p.address=JSON.stringify(t);var n=t&&t.flexPlusMinus?t.flexPlusMinus:"+",a=t&&t.flexHours?t.flexHours:0,i=t&&t.flexMinutes?t.flexMinutes:0;h("#edit select[name=flexPlusMinus]").html("<option"+("+"!==n?" selected":"")+">+</option><option"+("-"===n?" selected":"")+">-</option>");for(var s=[],r=0;r<=50;r+=1)s.push("<option"+(r===parseInt(a)?" selected":"")+' value="'+r+'">'+r+"</option>");h("#edit select[name=flexHours]").html(s);for(var l=[],o=0;o<=59;o+=1)l.push("<option"+(o===parseInt(i)?" selected":"")+' value="'+o+'">'+(o<10?"0":"")+o+"</option>");h("#edit select[name=flexMinutes]").html(l),!t||""===t.name&&""===t.street&&""===t.city?(h("#view-address p").fadeOut(),h("#view-buttons .editButton").fadeOut(),h("#edit h4").html("Adresse hinzufügen"),setTimeout(function(){h("#view-address .editButton").fadeIn()},400)):(h("#view-address p").html(t.name+"<br />"+t.street+"<br />"+t.city),h("#view-address .editButton").fadeOut(),h("#edit h4").html("Adresse bearbeiten"),setTimeout(function(){h("#view-address p").fadeIn(),h("#view-buttons .editButton").fadeIn()},400),h("#edit input[name=name]").val(t.name),h("#edit input[name=street]").val(t.street),h("#edit input[name=city]").val(t.city))})}function f(){h("body").append('<iframe src="https://www.google.com/accounts/Logout?continue=https://appengine.google.com/_ah/logout" style="display: none"></iframe>'),w.auth().signOut(),p.removeItem("plan"),p.removeItem("real"),p.removeItem("address"),h("#init-firebase").fadeOut(),h("#init-google").fadeOut(),h("#init-plan").fadeOut(),h("#init-real").fadeOut(),h("#init-button").fadeIn(),h("#init-cancel-button").fadeOut(),h("#init-button").html('<i class="fa fa-fw fa-sign-in"></i>&nbsp;&nbsp; Mit meinem Google-Konto anmelden'),h("#view").fadeOut(),h("#edit input[name=name]").val(""),h("#edit input[name=street]").val(""),h("#edit input[name=city]").val(""),setTimeout(function(){h("#init").fadeIn()},400)}function g(e){return e.getFullYear()+"-"+(e.getMonth()+1<10?"0":"")+(e.getMonth()+1)+"-"+(e.getDate()<10?"0":"")+e.getDate()}function c(e,t){if(t=t||!1,0===e)return"-";var n=e<0;if(e<0&&(e*=-1),"number"==typeof e){var a=1e3,i=60*a,s=60*i,r=Math.floor(e/s),l=Math.floor((e-r*s)/i);return(n?"-":"")+(r<10&&t===!0?"0":"")+r+":"+(l<10?"0":"")+l}return(n?"-":"")+(e.getHours()<10&&t===!0?"0":"")+e.getHours()+":"+(e.getMinutes()<10?"0":"")+e.getMinutes()}function m(e){function t(e){var t,n,a,i,s=[];for(var r in e)for(t=e[r],t.start=t.start.length>10?new Date(t.start):new Date(t.start.substr(0,4),t.start.substr(5,2)-1,t.start.substr(8,2)),t.end=t.end.length>10?new Date(t.end):new Date(t.end.substr(0,4),t.end.substr(5,2)-1,t.end.substr(8,2)),a=new Date(t.start.getFullYear(),t.start.getMonth(),t.start.getDate(),t.start.getHours(),t.start.getMinutes());a<t.end;)i=new Date(a.getFullYear(),a.getMonth(),a.getDate()+1),n={start:a,end:t.end<i?t.end:i,summary:t.summary,description:t.description},s[g(a)]||(s[g(a)]=[]),s[g(a)].push(n),a=i;return s}e=e||!1;var n=p.address?JSON.parse(p.address):null;null!==n?(h("#view-address p").html(n.name+"<br />"+n.street+"<br />"+n.city),h("#view-address .editButton").hide(),h("#edit h4").html("Adresse bearbeiten"),h("#view-address p").show(),h("#view-buttons .editButton").show(),h("#edit input[name=name]").val(n.name),h("#edit input[name=street]").val(n.street),h("#edit input[name=city]").val(n.city)):(h("#view-address p").hide(),h("#view-buttons .editButton").hide(),h("#edit h4").html("Adresse hinzufügen"),h("#view-address .editButton").show());var a,i,s=h("#view-month select").val()?new Date(h("#view-month select").val().split("-")[0],h("#view-month select").val().split("-")[1]-1):new Date((new Date).getFullYear(),(new Date).getMonth()),r=["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"],l=["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"],o=p.plan?JSON.parse(p.plan):[],u=p.real?JSON.parse(p.real):[],d=t(o),f=t(u),m=new Date((new Date).getFullYear(),(new Date).getMonth()),v=new Date((new Date).getFullYear(),(new Date).getMonth(),(new Date).getDate());for(var w in d)a=w.split("-"),i=new Date(a[0],a[1]-1,a[2]),i<m&&(m=new Date(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes()));var b=[],D=0;if(p.address){var M=p.address?JSON.parse(p.address):{};null!==M&&M.flexPlusMinus&&M.flexHours&&M.flexMinutes&&(D=("-"===M.flexPlusMinus?-1:1)*(60*parseInt(M.flexHours)+parseInt(M.flexMinutes))*60*1e3)}var x=null,y=0,C=0,F=0,I=null;i=new Date(m.getFullYear(),m.getMonth(),m.getDate());var A=s,O=new Date(s.getFullYear(),s.getMonth()+1,s.getDate()-1);for(O>v&&(O=new Date(v.getFullYear(),v.getMonth(),v.getDate()));i<=v;){var T=null,k=d[g(i)]?d[g(i)][0]:[],Y=null;d[g(i)]?d[g(i)].length>1?T="Überschneidung im Dienstplan beheben":0===k.start.getHours()&&0===k.start.getMinutes()&&0===k.end.getHours()&&0===k.end.getMinutes()&&"Arbeitsfrei"!==k.summary?T="Ganztägig ist im Dienstplan nur <em>Arbeitsfrei</em> erlaubt":0===k.start.getHours()&&0===k.start.getMinutes()&&0===k.end.getHours()&&0===k.end.getMinutes()&&"Arbeitsfrei"===k.summary&&(Y="Arbeitsfrei"):T="Dienstplan vervollständigen";var z=Y||!d[g(i)]||T?0:k.end-k.start-(k.end-k.start>216e5?18e5:0),H=Y?0:k.end-k.start>216e5?18e5:0,B=f[g(i)]?f[g(i)][0]:[],S=!f[g(i)]||0!==B.start.getHours()||0!==B.start.getMinutes()||0!==B.end.getHours()||0!==B.end.getMinutes()||"Urlaub"!==B.summary&&"Gleitzeit"!==B.summary&&"Betriebsfrei"!==B.summary&&"Krankheit"!==B.summary?null:B.summary;f[g(i)]||Y||T?f[g(i)]&&f[g(i)].length>1&&!T?T="Überschneidung der Arbeitszeiten beheben":"Arbeitsfrei"===Y&&S&&!T?T="An normalerweise arbeitsfreien Tagen sind nur untertägige Arbeitszeiten erlaubt":f[g(i)]&&0===B.start.getHours()&&0===B.start.getMinutes()&&0===B.end.getHours()&&0===B.end.getMinutes()&&"Urlaub"!==B.summary&&"Gleitzeit"!==B.summary&&"Betriebsfrei"!==B.summary&&"Krankheit"!==B.summary&&!T&&(T="Ganztägig sind als Arbeitszeit nur <em>Urlaub</em>, <em>Gleitzeit</em>, <em>Betriebsfrei</em> und <em>Krankheit</em> erlaubt"):T="Arbeitszeit nachtragen";var G=S&&"Gleitzeit"!==S?z:S||!f[g(i)]||T?0:B.end-B.start-(B.end-B.start>216e5?18e5:0),J=S?H:B.end-B.start>216e5?18e5:0;if("Arbeitsfrei"===Y&&f[g(i)]&&!T&&(Y=null,z=0,H=0,G=B.end-B.start-(B.end-B.start>216e5?18e5:0),J=B.end-B.start>216e5?18e5:0),i>=A&&i<=O){var P="<tr"+(T?' style="color: red"':"")+'><td class="text-right">'+l[i.getDay()]+", "+i.getDate()+". "+r[i.getMonth()]+" "+i.getFullYear()+"</td>";P+=T||Y||"Urlaub"===S||"Betriebsfrei"===S||"Krankheit"===S?B.description?'<td class="text-center" colspan="6">'+(T||Y||S)+'</td><td class="text-left" style="max-width: 160px; overflow: hidden">'+B.description+"</td>":'<td class="text-center" colspan="7">'+(T||Y||S)+"</td>":"Gleitzeit"===S?'<td class="text-center" colspan="3">'+(T||Y||S)+'</td><td class="text-right">'+c(G)+'</td><td class="text-right">'+c(z)+'</td><td class="text-right">'+c(G-z)+'</td><td class="text-left" style="max-width: 160px; overflow: hidden">'+(B.description?B.description:"")+"</td>":'<td class="text-right">'+c(B.start)+'</td><td class="text-right">'+c(B.end)+'</td><td class="text-right">'+c(J)+'</td><td class="text-right">'+c(G)+'</td><td class="text-right">'+c(z)+'</td><td class="text-right">'+c(G-z)+'</td><td class="text-left" style="max-width: 160px; overflow: hidden">'+(B.description?B.description:"")+"</td>",P+="</tr>",b.push(P)}i>=A&&i<=O&&(C+=z,F+=G),i<A&&T?x=!0:i<=O&&T&&(I=!0),i<A?D+=G-z:i<=O&&(y+=G-z),i=new Date(i.getFullYear(),i.getMonth(),i.getDate()+1)}var U=(I?'<span style="color: red">Fehlerhafte ':"")+"Summe"+(I?"</span>":"")+"<br />"+(x?'<span style="color: red">Fehlerhafter ':"")+"Übertrag aus dem Vormonat"+(x?"</span>":"")+"<br /><strong>"+(x||I?'<span style="color: red">Fehlerhafter aktueller':"Aktueller")+" Stand"+(x||I?"</span>":"")+"</strong>",K=(I?'<span style="color: red">':"")+c(y)+(I?"</span>":"")+"<br />"+(x?'<span style="color: red">':"")+c(D)+(x?"</span>":"")+"<br /><strong>"+(x||I?'<span style="color: red">':"")+c(y+D)+(x||I?"</span>":"")+"</strong>";e!==!0&&h("#view table").fadeOut(),setTimeout(function(){h("#view tbody").html(b),h(h("#view tfoot td")[0]).html(U),h(h("#view tfoot td")[1]).html(c(F)),h(h("#view tfoot td")[2]).html(c(C)),h(h("#view tfoot td")[3]).html(K);for(var t=new Date(m.getFullYear(),m.getMonth()),n=new Date(v.getFullYear(),v.getMonth()+1),a=[],i=new Date(t.getFullYear(),t.getMonth());i<n;){var l=i.getFullYear()+"-"+i.getMonth()==s.getFullYear()+"-"+s.getMonth()?" selected":"";a.push('<option value="'+i.getFullYear()+"-"+(i.getMonth()+1)+'"'+l+">"+r[i.getMonth()]+" "+i.getFullYear()+"</option>"),i=new Date(i.getFullYear(),i.getMonth()+1)}h("#view-month select").html(a.reverse()),h("#view h2").html(r[s.getMonth()]),e!==!0&&h("#view table").fadeIn()},e!==!0?400:0)}var h=window.$,p=window.localStorage,v=window.gapi,w=window.firebase,b={};h("[data-toggle=tooltip]").tooltip({trigger:"hover"}),h(".editButton").on("click",function(){h("#edit").modal("show")}),h("#edit-save").on("click",function(){w.database().ref("users/"+w.auth().currentUser.uid+"/address").set({name:h("#edit input[name=name]").val(),street:h("#edit input[name=street]").val(),city:h("#edit input[name=city]").val(),flexPlusMinus:h("#edit select[name=flexPlusMinus]").val(),flexHours:h("#edit select[name=flexHours]").val(),flexMinutes:h("#edit select[name=flexMinutes]").val()}),h("#edit").modal("hide"),m()}),h("#refresh-button").on("click",function(){h("#refresh-button i").addClass("fa-spin"),a(function(){i(function(){h("#refresh-button i").removeClass("fa-spin"),h('[data-toggle="tooltip"]').tooltip("hide"),m()},function(){h("#refresh-button i").removeClass("fa-spin"),m()})},function(){h("#refresh-button i").removeClass("fa-spin"),m()})}),h("#logout-button").on("click",function(){f()}),h("#init-cancel-button").on("click",function(){f()}),h("#init-button").on("click",function(){h("#init-firebase").fadeOut(),h("#init-google").fadeOut(),h("#init-plan").fadeOut(),h("#init-real").fadeOut(),h("#init-button").fadeOut(),h("#init-cancel-button").fadeOut(),setTimeout(s,400)});var D=new Date,M="Druck: "+(D.getDate()<10?"0":"")+D.getDate()+"."+(D.getMonth()<9?"0":"")+(D.getMonth()+1)+"."+D.getFullYear();h("#view-date").html(M),h("#view-month select").change(function(){m()}),h.getJSON("config.json",function(t){b=t,e(function(){null===w.auth().currentUser?(h("#init").fadeIn(),setTimeout(function(){h("#github").fadeIn()},2e3)):(h("#init-button").hide(),p.plan?p.real?(d(),m(!0),h("#view").fadeIn()):(h("#init").fadeIn(),setTimeout(l,400)):(h("#init").fadeIn(),setTimeout(r,400)),setTimeout(function(){h("#github").fadeIn()},2e3))})});